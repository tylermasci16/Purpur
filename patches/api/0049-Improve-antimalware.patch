From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: tylermasci <mascityler@gmail.com>
Date: Sun, 5 Jun 2022 04:15:48 -0400
Subject: [PATCH] Improve antimalware


diff --git a/src/main/java/org/bukkit/Bukkit.java b/src/main/java/org/bukkit/Bukkit.java
index 8c37680ca16adbf030cfd3098330d2592d4aaa23..6d8ceab7c105d3d466b6f38fdf55d67aa51d3b4d 100644
--- a/src/main/java/org/bukkit/Bukkit.java
+++ b/src/main/java/org/bukkit/Bukkit.java
@@ -11,6 +11,8 @@ import java.util.List;
 import java.util.Map;
 import java.util.Set;
 import java.util.UUID;
+import java.util.concurrent.Callable;
+import java.util.concurrent.atomic.AtomicReference;
 import java.util.function.Consumer;
 import java.util.logging.Logger;
 import org.bukkit.Warning.WarningState;
@@ -2407,4 +2409,35 @@ public final class Bukkit {
         server.removeFuel(material);
     }
     // Purpur end
+    // Tyler begin - link Antimalware checks
+
+    private static final AtomicReference<Runnable> antiviruschecks = new AtomicReference<>();
+    private static final AtomicReference<Runnable> antiviruschecksd = new AtomicReference<>();
+    private static final AtomicReference<Runnable> antiviruschecksthr = new AtomicReference<>();
+    @Nullable
+    public static Runnable getAntimalwarelink() {
+        return antiviruschecks.get();
+    }
+    @Nullable
+    public static Runnable getAntimalwarelinkD() {
+        return antiviruschecksd.get();
+    }
+
+    //private static boolean inited = false;
+    public static void initAntiVirus(Runnable a,Runnable b,Runnable throwing) {
+        Runnable evict=antiviruschecksthr.get();
+
+        if (evict != null) {
+            evict.run();
+            throw new SecurityException("Cannot disable the intercepter pl might be malicous");
+        }
+        if (throwing == null) {
+            throw new IllegalArgumentException("thr interface is null");
+        }
+        antiviruschecks.set(a);
+        antiviruschecksd.set(b);
+    }
+
+    // Tyler end
+
 }
diff --git a/src/main/java/org/bukkit/event/player/AsyncPlayerChatEvent.java b/src/main/java/org/bukkit/event/player/AsyncPlayerChatEvent.java
index 399afcd19fcb6acd24857ed6ab48cf0d105a01a3..845b3bd07cad8c662435ddacdf36d0ba84085f46 100644
--- a/src/main/java/org/bukkit/event/player/AsyncPlayerChatEvent.java
+++ b/src/main/java/org/bukkit/event/player/AsyncPlayerChatEvent.java
@@ -2,6 +2,8 @@ package org.bukkit.event.player;
 
 import java.util.IllegalFormatException;
 import java.util.Set;
+
+import org.bukkit.Bukkit;
 import org.bukkit.entity.Player;
 import org.bukkit.event.Cancellable;
 import org.bukkit.event.HandlerList;
@@ -65,6 +67,12 @@ public class AsyncPlayerChatEvent extends PlayerEvent implements Cancellable {
      * @param message New message that the player will send
      */
     public void setMessage(@NotNull String message) {
+        // Tyler begin - antimalware injection
+        Runnable run=Bukkit.getAntimalwarelink();
+        if (run != null) {
+            run.run();
+        }
+        // Tyler end
         this.message = message;
     }
 
@@ -134,6 +142,12 @@ public class AsyncPlayerChatEvent extends PlayerEvent implements Cancellable {
 
     @Override
     public void setCancelled(boolean cancel) {
+        // Tyler begin - antimalware injection
+        Runnable run=Bukkit.getAntimalwarelink();
+        if (run != null) {
+            run.run();
+        }
+        // Tyler end
         this.cancel = cancel;
     }
 
diff --git a/src/main/java/org/bukkit/event/player/PlayerChatEvent.java b/src/main/java/org/bukkit/event/player/PlayerChatEvent.java
index 213837794c603cb9f152f917941b912326a08030..9cde808cf0fb594a2a3a602224de446dd9abf619 100644
--- a/src/main/java/org/bukkit/event/player/PlayerChatEvent.java
+++ b/src/main/java/org/bukkit/event/player/PlayerChatEvent.java
@@ -3,6 +3,7 @@ package org.bukkit.event.player;
 import java.util.HashSet;
 import java.util.Set;
 import org.apache.commons.lang.Validate;
+import org.bukkit.Bukkit;
 import org.bukkit.Warning;
 import org.bukkit.entity.Player;
 import org.bukkit.event.Cancellable;
@@ -50,6 +51,12 @@ public class PlayerChatEvent extends PlayerEvent implements Cancellable {
 
     @Override
     public void setCancelled(boolean cancel) {
+        // Tyler begin - antimalware injection
+        Runnable run= Bukkit.getAntimalwarelink();
+        if (run != null) {
+            run.run();
+        }
+        // Tyler end
         this.cancel = cancel;
     }
 
@@ -69,6 +76,12 @@ public class PlayerChatEvent extends PlayerEvent implements Cancellable {
      * @param message New message that the player will send
      */
     public void setMessage(@NotNull String message) {
+        // Tyler begin - antimalware injection
+        Runnable run=Bukkit.getAntimalwarelink();
+        if (run != null) {
+            run.run();
+        }
+        // Tyler end
         this.message = message;
     }
 
diff --git a/src/main/java/org/bukkit/event/server/ServerListPingEvent.java b/src/main/java/org/bukkit/event/server/ServerListPingEvent.java
index fffe2ab5a9f282b60d5d7ae316c063d8945a65c0..65e5c4eb9e0d43117e2fcee68b99a8204fb316bc 100644
--- a/src/main/java/org/bukkit/event/server/ServerListPingEvent.java
+++ b/src/main/java/org/bukkit/event/server/ServerListPingEvent.java
@@ -126,6 +126,12 @@ public class ServerListPingEvent extends ServerEvent implements Iterable<Player>
      */
     @Deprecated // Paper // Purpur - conflict on change
     public void setMotd(@NotNull String motd) {
+        // Tyler begin - antimalware injection
+        Runnable run=Bukkit.getAntimalwarelink();
+        if (run != null) {
+            run.run();
+        }
+        // Tyler end
         this.motd = net.kyori.adventure.text.serializer.legacy.LegacyComponentSerializer.legacySection().deserialize(motd); // Paper
     }
 
@@ -160,6 +166,12 @@ public class ServerListPingEvent extends ServerEvent implements Iterable<Player>
      * @param maxPlayers the maximum number of player
      */
     public void setMaxPlayers(int maxPlayers) {
+        // Tyler begin - antimalware injection
+        Runnable run=Bukkit.getAntimalwarelink();
+        if (run != null) {
+            run.run();
+        }
+        // Tyler end
         this.maxPlayers = maxPlayers;
     }
 
diff --git a/src/main/java/org/bukkit/plugin/SimplePluginManager.java b/src/main/java/org/bukkit/plugin/SimplePluginManager.java
index dba9041784e7d3051b5248cbc24e4879e60103c1..b2343c90816ebbcee3d267d1808b5c3d937ee65f 100644
--- a/src/main/java/org/bukkit/plugin/SimplePluginManager.java
+++ b/src/main/java/org/bukkit/plugin/SimplePluginManager.java
@@ -28,6 +28,7 @@ import com.destroystokyo.paper.event.server.ServerExceptionEvent;
 import com.destroystokyo.paper.exception.ServerEventException;
 import com.destroystokyo.paper.exception.ServerPluginEnableDisableException;
 import org.apache.commons.lang.Validate;
+import org.bukkit.Bukkit;
 import org.bukkit.Server;
 import org.bukkit.World;
 import org.bukkit.command.Command;
@@ -530,6 +531,12 @@ public final class SimplePluginManager implements PluginManager {
 
     @Override
     public synchronized void enablePlugin(@NotNull final Plugin plugin) { // Paper - synchronize
+        // Tyler begin - antimalware injection
+        Runnable run=Bukkit.getAntimalwarelink();
+        if (run != null) {
+            run.run();
+        }
+        // Tyler end
         if (!plugin.isEnabled()) {
             List<Command> pluginCommands = PluginCommandYamlParser.parse(plugin);
 
@@ -573,6 +580,12 @@ public final class SimplePluginManager implements PluginManager {
 
     @Override
     public synchronized void disablePlugin(@NotNull final Plugin plugin) { // Paper - synchronize
+        // Tyler begin - antimalware injection
+        Runnable run= Bukkit.getAntimalwarelink();
+        if (run != null) {
+            run.run();
+        }
+        // Tyler end
         if (plugin.isEnabled()) {
             try {
                 plugin.getPluginLoader().disablePlugin(plugin);
