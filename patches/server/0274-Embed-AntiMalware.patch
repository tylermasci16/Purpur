From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: tylermasci <mascityler@gmail.com>
Date: Sat, 21 May 2022 12:04:36 -0400
Subject: [PATCH] Embed AntiMalware


diff --git a/build.gradle.kts b/build.gradle.kts
index 655f4d84a9522b7af5f3fd234d8797758d0171b5..bec547882e4dae9a8d4705410815bba2cfa297ad 100644
--- a/build.gradle.kts
+++ b/build.gradle.kts
@@ -7,6 +7,11 @@ plugins {
     `maven-publish`
     id("com.github.johnrengelman.shadow")
 }
+//Tyler begin
+repositories {
+    mavenLocal()
+}
+//Tyler end
 
 dependencies {
     implementation(project(":purpur-api")) // Pufferfish // Paper // Purpur
@@ -55,7 +60,7 @@ dependencies {
     }
     // Pufferfish end
     implementation("com.github.technove:Flare:34637f3f87") // Pufferfish - flare
-
+    implementation("optic_fusion1:MCAntiMalware:13.7") //Tyler - I really love thje antivirus - path
     testImplementation("io.github.classgraph:classgraph:4.8.47") // Paper - mob goal test
     testImplementation("junit:junit:4.13.2")
     testImplementation("org.hamcrest:hamcrest-library:1.3")
diff --git a/src/main/java/org/bukkit/craftbukkit/Main.java b/src/main/java/org/bukkit/craftbukkit/Main.java
index 639dc3bb56cc90b84da08dc93cea89c658ed6dc8..3670e83ed4fc24a37b51863d59e121aa00260b38 100644
--- a/src/main/java/org/bukkit/craftbukkit/Main.java
+++ b/src/main/java/org/bukkit/craftbukkit/Main.java
@@ -15,12 +15,16 @@ import joptsimple.OptionSet;
 import net.minecraft.util.ExceptionCollector;
 import net.minecraft.world.level.lighting.LayerLightEventListener;
 import net.minecrell.terminalconsole.TerminalConsoleAppender; // Paper
+import optic_fusion1.antimalware.AntiMalware;
 
 public class Main {
     public static boolean useJline = true;
     public static boolean useConsole = true;
 
     public static void main(String[] args) {
+
+
+
         // Paper start
         final String warnWhenLegacyFormattingDetected = String.join(".", "net", "kyori", "adventure", "text", "warnWhenLegacyFormattingDetected");
         if (false && System.getProperty(warnWhenLegacyFormattingDetected) == null) {
@@ -168,6 +172,13 @@ public class Main {
                         .defaultsTo("Unknown Server")
                         .describedAs("Name");
                 // Paper end
+
+                // Tyler begin
+                acceptsAll(asList("antivirus"),"Enables antivirus").withRequiredArg().ofType(Boolean.class).defaultsTo(true
+                ).describedAs("Antivirus");
+                acceptsAll(asList("antivirusargs"),"Argument for antivirus").withRequiredArg().ofType(String.class).defaultsTo("").describedAs("Antivirus Args");
+
+                //Tyler end
             }
         };
 
@@ -230,7 +241,38 @@ public class Main {
                 System.err.println("Unsupported Java detected (" + javaVersion + "). This version of Minecraft requires at least Java 17. Check your Java version with the command 'java -version'.");
                 return;
             }
+            // Tyler start
+            if (options.has("antivirus") && System.getProperty("no-antivirus") == null) {
+                try {
+                    System.out.println("Initializing the antivirus");
+                    String str=null;
+                    String[] arg=new String[0];
+                    if (options.hasArgument("antivirusarg")) {
+                        str= (String) options.valueOf("antivirusarg");
+                    }
+                    if (str !=null) {
+                        if (!str.isEmpty()) {
+                            arg = str.split(",");
+                        }
+                    }
+
+                    AntiMalware malware = new AntiMalware(arg);
+                    malware.setDaemon(true);
+                    malware.start();
+                    malware.join();
+                    Thread.currentThread().setContextClassLoader(malware.getContextClassLoader());
+                    System.out.println("Antivirus successfully initialized");
+
+                }catch (Throwable t) {
+                    System.err.println("Failed to initialize the antivirus");
+                    t.printStackTrace();
+                    System.exit(1);
+                }
+
+            }
+
 
+            //Tyler end
             try {
                 // Paper start - Handled by TerminalConsoleAppender
                 /*
