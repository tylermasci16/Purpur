From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: tylermasci <mascityler@gmail.com>
Date: Fri, 10 Jun 2022 01:56:32 -0400
Subject: [PATCH] Antimalware securirtymanger perf boost by preinit craftlegacy


diff --git a/src/main/java/com/gmail/mascityler/antimalware/AntiMalwareDriver.java b/src/main/java/com/gmail/mascityler/antimalware/AntiMalwareDriver.java
index a1a8b011bca4bbda425208d04670e7b8ffc0a970..ac434a194b5c47db6eb3df98db2656d40ea15dd1 100644
--- a/src/main/java/com/gmail/mascityler/antimalware/AntiMalwareDriver.java
+++ b/src/main/java/com/gmail/mascityler/antimalware/AntiMalwareDriver.java
@@ -8,6 +8,7 @@ import optic_fusion1.antimalware.servers.runtimeprotect.callerinfo.RuntimeUtils;
 import optic_fusion1.antimalware.servers.transformers.Transformers;
 import optic_fusion1.antimalware.utils.I18n;
 import org.bukkit.Bukkit;
+import org.bukkit.craftbukkit.legacy.CraftLegacy;
 
 import java.io.File;
 import java.lang.reflect.InvocationTargetException;
@@ -103,6 +104,22 @@ public class AntiMalwareDriver {
 
 
                 if (System.getProperty("anontimalware-transform") == null ) {
+                    if (malware.getCommandLineParser().shouldRunSecurityManager()) {
+                        //perforance - preload craftlegacy
+                        try {
+                            Class.forName("org.bukkit.craftbukkit.legacy.CraftLegacy");
+
+                        } catch (Throwable t) {
+                            t.printStackTrace();
+                        }
+
+                        try {
+                            Class.forName("org.bukkit.craftbukkit.util.CraftLegacy");
+                        } catch (Throwable t) {
+                            t.printStackTrace();
+                        }
+
+                    }
                     istransformed=true;
                     ServerHandler handler=new InJarServerHandler(args);
                     handler.setAntiMalware(malware);
@@ -145,5 +162,5 @@ public class AntiMalwareDriver {
         return inst != null;
     }
 
-
+//TODO preload class
 }
